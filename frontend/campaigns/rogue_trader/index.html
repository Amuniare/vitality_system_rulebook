<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rogue Trader Campaign - Vitality System</title>
    <link rel="stylesheet" href="../../rules/viewer/style.css">
    <link rel="stylesheet" href="theme-warrant.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Add active state for sidebar nav items */
        .sidebar .nav-item.active {
            background-color: #34495e;
            border-left-color: var(--color-accent-gold, #cfa32b);
            color: white;
            font-weight: bold;
        }
        /* Style for the lore table of contents */
        .lore-toc {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }
    </style>
</head>
<body class="theme-warrant">
    <div class="warrant-container">
        <!-- The sidebar now dynamically shows sub-navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Rogue Trader Campaign</h2>
                <p>The Eternal Vigil</p>
                
                <div class="nav-links">
                    <a href="../../index.html" class="nav-link">Hub Home</a>
                    <a href="../../rules/index.html" class="nav-link">Rulebook</a>
                    <a href="../../character-builder/character-builder.html" class="nav-link">Character Builder</a>
                    <a href="../index.html" class="nav-link">All Campaigns</a>
                </div>
            </div>

            <!-- This content will be dynamically generated by JS -->
            <div class="nav-content" id="nav-content">
                <div class="loading">Loading navigation...</div>
            </div>
        </nav>
        
        <main class="content" id="main-content-area">
            <header class="hub-header">
                <h1>Rogue Trader Campaign: The Eternal Vigil</h1>
                <p>A Warhammer 40,000 Campaign of Power, Corruption, and Discovery</p>
            </header>


            <!-- Single content area that gets updated -->
            <div class="tab-content active" id="content-display">
                <div class="loading-tab">Loading content...</div>
            </div>
        </main>
    </div>
    
    <script>
        class RogueTraderCampaignApp {
            constructor() {
                // Hierarchical configuration for tabs and their documents
                this.tabConfig = {
                    'briefing': {
                        label: 'Briefing',
                        defaultDoc: 'overview',
                        docs: {
                            'overview': { label: 'Campaign Overview', path: 'briefing/campaign_overview.md' },
                            'basics': { label: 'Warhammer Lore Basics', path: 'briefing/warhammer_lore_basics.md' },
                            'timeline': { label: 'Galactic Timeline', path: 'briefing/timeline.md' }
                        }
                    },
                    'lore': {
                        label: 'Lore Archives',
                        defaultDoc: 'authority',
                        docs: {
                            'authority': { label: 'Rogue Trader Authority', path: 'lore/rogue-trader-authority.md' },
                            'factions': { label: 'Factions', path: 'lore/factions.md' },
                            'government': { label: 'Imperial Government', path: 'lore/imperial-government.md' },
                            'warp': { label: 'The Warp & Chaos', path: 'lore/warp-and-chaos.md' },
                            'technology': { label: 'Technology', path: 'lore/technology.md' }
                        }
                    },
                    'logbook': {
                        label: 'Campaign Log',
                        defaultDoc: 'characters',
                        docs: {
                            'characters': { label: 'Player Characters', path: 'campaign_log/player-characters.md' },
                            'npcs': { label: 'NPCs', path: 'campaign_log/npcs.md' },
                            'summaries': { label: 'Session Summaries', path: 'campaign_log/session-summaries.md' },
                            'notes': { label: 'Dynasty Resources', path: 'campaign_log/dynasty-resources.md' }
                        }
                    }
                };
                
                this.activeMainTab = 'briefing';
                this.activeDocKey = 'overview';
                this.loadedDocs = new Map(); // Cache for loaded markdown content

                this.init();
            }

            async init() {
                this.setupEventListeners();
                this.renderSidebar();
                await this.loadDocument(this.tabConfig[this.activeMainTab].docs[this.activeDocKey].path);
            }
            
            // Renders the sidebar with all sections and their documents
            renderSidebar() {
                const navContent = document.getElementById('nav-content');
                if (!navContent) return;

                let navHTML = '';
                
                // Generate hierarchical navigation for all tabs
                Object.entries(this.tabConfig).forEach(([tabKey, tabData]) => {
                    // Add main section header (h1)
                    navHTML += `
                        <a href="#" class="nav-item h1" data-action="select-section" data-section="${tabKey}">
                            ${tabData.label}
                        </a>
                    `;
                    
                    // Add documents under this section (h2)
                    Object.entries(tabData.docs).forEach(([docKey, doc]) => {
                        const isActive = (tabKey === this.activeMainTab && docKey === this.activeDocKey);
                        navHTML += `
                            <a href="#" class="nav-item h2 ${isActive ? 'active' : ''}" 
                               data-action="select-doc" data-tab="${tabKey}" data-doc-key="${docKey}">
                                ${doc.label}
                            </a>
                        `;
                    });
                });
                
                navContent.innerHTML = navHTML;
            }

            // Fetches and renders a single markdown file into the main content area
            async loadDocument(path) {
                const contentDisplay = document.getElementById('content-display');
                contentDisplay.innerHTML = '<div class="loading-tab">Loading content...</div>';
                
                if (this.loadedDocs.has(path)) {
                    contentDisplay.innerHTML = this.loadedDocs.get(path);
                    return;
                }

                try {
                    const response = await fetch(path);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const markdown = await response.text();
                    if (markdown.trim() === '') {
                        contentDisplay.innerHTML = `<div class="empty-state">This document is empty or not yet created.</div>`;
                        this.loadedDocs.set(path, contentDisplay.innerHTML);
                        return;
                    }

                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = marked.parse(markdown);
                    this.addHeadingIdsToElement(tempDiv);
                    
                    contentDisplay.innerHTML = tempDiv.innerHTML;
                    this.loadedDocs.set(path, contentDisplay.innerHTML);
                } catch (error) {
                    contentDisplay.innerHTML = `<div class="error">Failed to load document: ${path}. ${error.message}</div>`;
                }
            }

            addHeadingIdsToElement(element) {
                const headings = element.querySelectorAll('h1, h2, h3');
                headings.forEach((heading, index) => {
                    if (!heading.id) {
                        heading.id = this.createSlug(heading.textContent) + '-' + index;
                    }
                });
            }

            createSlug(text) {
                return text.toLowerCase().replace(/[^\\w\\s-]/g, '').replace(/\\s+/g, '-').trim();
            }
            
            async handleSectionClick(sectionKey) {
                // For section headers, load the default document for that section
                if (sectionKey === this.activeMainTab) return;

                this.activeMainTab = sectionKey;
                this.activeDocKey = this.tabConfig[sectionKey].defaultDoc;

                this.renderSidebar();
                const defaultDocPath = this.tabConfig[sectionKey].docs[this.activeDocKey].path;
                await this.loadDocument(defaultDocPath);
            }

            async handleDocSwitch(tabKey, docKey) {
                if (tabKey === this.activeMainTab && docKey === this.activeDocKey) return;
                
                this.activeMainTab = tabKey;
                this.activeDocKey = docKey;
                
                // Update active class in sidebar
                this.renderSidebar();
                
                const docPath = this.tabConfig[tabKey].docs[docKey].path;
                await this.loadDocument(docPath);
            }

            setupEventListeners() {
                document.addEventListener('click', (e) => {
                    const sectionLink = e.target.closest('.nav-item[data-action="select-section"]');
                    const docLink = e.target.closest('.nav-item[data-action="select-doc"]');
                    const menuToggle = e.target.closest('.menu-toggle');

                    if (sectionLink) {
                        e.preventDefault();
                        this.handleSectionClick(sectionLink.dataset.section);
                    } else if (docLink) {
                        e.preventDefault();
                        this.handleDocSwitch(docLink.dataset.tab, docLink.dataset.docKey);
                    } else if (menuToggle) {
                         document.getElementById('sidebar').classList.toggle('open');
                    }
                });

                // Add mobile menu toggle button if it doesn't exist
                if (!document.querySelector('.menu-toggle')) {
                    const menuToggle = document.createElement('button');
                    menuToggle.className = 'menu-toggle';
                    menuToggle.innerHTML = 'â˜° Menu';
                    document.body.appendChild(menuToggle);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new RogueTraderCampaignApp();
        });
    </script>
</body>
</html>
