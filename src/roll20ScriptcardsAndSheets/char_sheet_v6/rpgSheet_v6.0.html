<main>

    <!-- VITALITY SYSTEM v6.0 CHARACTER SHEET -->
    <!-- Updated: 2025-10-01 -->
    <!-- Changes from v5.5: Updated stat formulas, attack types, conditions, upgrades, and added Limits system -->
    <!-- Primary Actions (Dodge/Brace/Fortify/Aim/Empower/Steady) = TEMPORARY bonuses until start of next turn -->

    <!-- Header  -->
    <div class="header">
        <h4>Hero Name </h4>
        <h4>Real Name </h4>
        <h5>Character Tier </h5>
        <h5>Efforts Used </h5>
        <h5>Destiny </h5>

        <input type="text" name="attr_character_name">
        <input type="text" name="attr_character_realname">
        <input type="number" name="attr_char_tier" value="4">

        <!-- Efforts Used Tracker -->
        <input type="number" name="attr_char_efforts_used" value="0">

        <button type="roll" name="char_destiny"
            value="&{template:rolls} {{title=Destiny}} {{subtitle=@{character_name} }} {{DC ?{DC?} = [[d100]]}}"></button>
    </div>


    <!-- Character Basics Section  -->
    <div class="basics">
        <!-- Stats  -->

        <div class="stats">
            <h5>Core Stats</h5>
            <h5>Score</h5>

            <span>Focus</span>
            <input type="number" name="attr_char_focus" value="0">

            <span>Mobility</span>
            <input type="number" name="attr_char_mobility" value="0">

            <span>Power</span>
            <input type="number" name="attr_char_power" value="0">

            <span>Endurance</span>
            <input type="number" name="attr_char_endurance" value="0">

            <span>Awareness</span>
            <input type="number" name="attr_char_awareness" value="0">

            <span>Communication</span>
            <input type="number" name="attr_char_communication" value="0">

            <span>Intelligence</span>
            <input type="number" name="attr_char_intelligence" value="0">
        </div>

        <!-- Defenses (v6.0: Primary Actions = TEMPORARY bonuses until start of next turn) -->
        <div class="defenses">
            <h5>Stats</h5>
            <h5>Score</h5>
            <h5>Mod</h5>
            <h5>Primary Actions</h5>


            <span>Avoidance</span>
            <input type="number" name="attr_display_avoidance" value="@{char_avoidance}" disabled="true">
            <input type="number" name="attr_char_avMod" value="0">
            <input type="checkbox" name="attr_char_avPrimaryAction" title="Dodge: +Tier until next turn">

            <span>Durability</span>
            <input type="number" name="attr_display_durability" value="@{char_durability}" disabled="true">
            <input type="number" name="attr_char_drMod" value="0">
            <input type="checkbox" name="attr_char_drPrimaryAction" title="Brace: +Tier until next turn">

            <span>Resolve</span>
            <input type="number" name="attr_display_resolve" value="@{char_resolve}" disabled="true">
            <input type="number" name="attr_char_rsMod" value="0">
            <input type="checkbox" name="attr_char_rsPrimaryAction" title="Fortify: +Tier until next turn">

            <span>Stability</span>
            <input type="number" name="attr_display_stability" value="(@{char_stability})" disabled="true">
            <input type="number" name="attr_char_sbMod" value="0">
            <input type="checkbox" name="attr_char_sbPrimaryAction" title="Fortify: +Tier until next turn">

            <span>Vitality</span>
            <input type="number" name="attr_display_vitality" value="@{char_vitality}" disabled="true">
            <input type="number" name="attr_char_vtMod" value="0">
            <input type="checkbox" name="attr_char_vtPrimaryAction" title="Fortify: +Tier until next turn">

            <span>Survival Check</span>
            <input type="number" class="invisible-preserve-layout" disabled="true">
            <input type="number" class="invisible-preserve-layout" disabled="true">
            <button type="roll" name="char_survival_check"
                value="&{template:rolls} {{title=Survival Check}} {{subtitle=@{character_name}}} {{consciousness=DC [[@{char_hp}*-1]]}} {{death=DC [[@{char_hp}*-1-20]]}} {{roll=[[d20]]}}"></button>
        </div>


        <!-- Offense Stats (v6.0: Primary Actions = TEMPORARY bonuses until start of next turn) -->

        <div class="settings">

            <h5>Stats</h5>
            <h5>Score</h5>
            <h5>Mod</h5>
            <h5>Primary Actions</h5>



            <span>Movement</span>
            <input type="number" name="attr_display_movement" value="@{char_movement}" disabled="true">
            <input type="number" name="attr_char_movementMod" value="0">
            <input type="checkbox" name="attr_char_movementPrimaryAction" title="Steady: +Tier until next turn">

            <span>Accuracy</span>
            <input type="number" name="attr_display_accuracy" value="@{char_accuracy}" disabled="true">
            <input type="number" name="attr_char_acMod" value="0">
            <input type="checkbox" name="attr_char_acPrimaryAction" title="Aim: +Tier until next turn">

            <span>Damage</span>
            <input type="number" name="attr_display_damage" value="@{char_damage}" disabled="true">
            <input type="number" name="attr_char_dgMod" value="0">
            <input type="checkbox" name="attr_char_dgPrimaryAction" title="Empower: +Tier until next turn">

            <span>Conditions</span>
            <input type="number" name="attr_display_conditions" value="@{char_conditions}" disabled="true">
            <input type="number" name="attr_char_cnMod" value="0">
            <input type="checkbox" name="attr_char_cnPrimaryAction" title="Empower: +Tier until next turn">

            <span>Initiative</span>
            <input type="number" name="attr_display_initiative" value="@{char_initiative}" disabled="true">
            <input type="number" name="attr_char_initiativeMod" value="0">
            <input type="number" class="invisible-preserve-layout" disabled="true">

            <span>Hit Points</span>
            <input type="number" name="attr_char_hp" value="100">
            <input type="number" name="attr_char_hp_max" value="100">

        </div>

    </div>





    <!-- Hide and Show Sections  -->

    <input type="hidden" name="attr_sheet_tab" class="tabs" value="character">
    <div class="buttons">
        <button type="action" name="act_combat">Combat</button>
        <button type="action" name="act_utility">Utility</button>
        <button type="action" name="act_other">Attack Building</button>
        <button type="action" name="act_notes">Notes</button>

    </div>



    <!-- Combat Classes  -->

    <div class="combat">


        <div class="traits">
            <h4>Passive / Conditional Bonuses</h4>
            <!-- Repeating Section -->
            <fieldset class="repeating_traits">
                <input type="checkbox" name="attr_traitActive" value="1">
                <input type="text" name="attr_traitName" value="" placeholder="Trait Name">
                <details>
                    <div class="bonuses-grid">
                        <label>AC Mod <input type="number" name="attr_traitAcBonus" value="0"></label>
                        <label>DG Mod <input type="number" name="attr_traitDgBonus" value="0"></label>
                        <label>CN Mod <input type="number" name="attr_traitCnBonus" value="0"></label>
                        <label>AV Mod <input type="number" name="attr_traitAvBonus" value="0"></label>
                        <label>DR Mod <input type="number" name="attr_traitDrBonus" value="0"></label>
                        <label>RS Mod <input type="number" name="attr_traitRsBonus" value="0"></label>
                        <label>SB Mod <input type="number" name="attr_traitSbBonus" value="0"></label>
                        <label>VT Mod <input type="number" name="attr_traitVtBonus" value="0"></label>
                        <label>M Mod <input type="number" name="attr_traitMBonus" value="0"></label>
                    </div>
                </details>
            </fieldset>




        </div>

        <div class="uniques">
            <h4>Unique Powers</h4>
            <fieldset class="repeating_uniqueAbilities">
                <button type="roll" name="char_uniqueAbilities"
                    value="&{template:rolls} {{title=@{char_uniqueAbilities} }} {{subtitle=@{character_name} }} {{desc=@{uniqueAbilitiesDesc} }}"></button>
                <input type="text" name="attr_char_uniqueAbilities" value="">
                <details>
                    <textarea name="attr_uniqueAbilitiesDesc" value=""></textarea>
                </details>
            </fieldset>
        </div>



    </div>



    <!-- Utility Classes  -->

    <div class="utility">


        <div class="features">
            <h4>Features, Descriptors and Senses</h4>
            <fieldset class="repeating_features">
                <button type="roll" name="char_features"
                    value="&{template:rolls} {{title=@{char_features} }} {{subtitle=@{character_name} }} {{desc=@{featuresDesc} }}"></button>
                <input type="text" name="attr_char_features" value="">
                <details>
                    <textarea name="attr_featuresDesc" value=""></textarea>
                </details>
            </fieldset>
        </div>



        <div class="expertises">
            <h4>Expertise</h4>

            <!-- Awareness Skills -->
            <button type="roll" name="roll_awarenessSkillCheck"
                value="&{template:rolls} {{title=Awareness Check}} {{subtitle=@{character_name} }} {{roll= [[3d6!+@{char_awareness}+@{awarenessTotal}]]}}"></button>
            <h5>Awareness Skills</h5>
            <fieldset class="repeating_awarenessExpertises">
                <input type="checkbox" name="attr_awarenessExpertiseActive">
                <input type="text" name="attr_awarenessExpertiseName" placeholder="Expertise Name">
            </fieldset>

            <!-- Communication Skills -->
            <button type="roll" name="roll_communicationSkillCheck"
                value="&{template:rolls} {{title=Communication Check}} {{subtitle=@{character_name} }} {{roll= [[3d6!+@{char_communication}+(@{communicationTotal})]]}}"></button>
            <h5>Communication Skills</h5>
            <fieldset class="repeating_communicationExpertises">
                <input type="checkbox" name="attr_communicationExpertiseActive" value="@{char_tier}">
                <input type="text" name="attr_communicationExpertiseName" value="" placeholder="Expertise Name">
            </fieldset>

            <!-- Intelligence Skills -->
            <button type="roll" name="roll_intelligenceSkillCheck"
                value="&{template:rolls} {{title=Intelligence Check}} {{subtitle=@{character_name} }} {{roll= [[3d6!+@{char_intelligence}+(@{intelligenceTotal})]]}}"></button>
            <h5>Intelligence Skills</h5>
            <fieldset class="repeating_intelligenceExpertises">
                <input type="checkbox" name="attr_intelligenceExpertiseActive" value="@{char_tier}">
                <input type="text" name="attr_intelligenceExpertiseName" value="" placeholder="Expertise Name">
            </fieldset>

            <!-- Focus Skills -->
            <button type="roll" name="roll_focusSkillCheck"
                value="&{template:rolls} {{title=Focus Check}} {{subtitle=@{character_name} }} {{roll= [[3d6!+@{char_focus}+(@{focusTotal})]]}}"></button>
            <h5>Focus Skills</h5>
            <fieldset class="repeating_focusExpertises">
                <input type="checkbox" name="attr_focusExpertiseActive" value="@{char_tier}">
                <input type="text" name="attr_focusExpertiseName" value="" placeholder="Expertise Name">
            </fieldset>

            <!-- Mobility Skills -->
            <button type="roll" name="roll_mobilitySkillCheck"
                value="&{template:rolls} {{title=Mobility Check}} {{subtitle=@{character_name} }} {{roll= [[3d6!+@{char_mobility}+(@{mobilityTotal})]]}}"></button>
            <h5>Mobility Skills</h5>
            <fieldset class="repeating_mobilityExpertises">
                <input type="checkbox" name="attr_mobilityExpertiseActive" value="@{char_tier}">
                <input type="text" name="attr_mobilityExpertiseName" value="" placeholder="Expertise Name">
            </fieldset>

            <!-- Endurance Skills -->
            <button type="roll" name="roll_enduranceSkillCheck"
                value="&{template:rolls} {{title=Endurance Check}} {{subtitle=@{character_name} }} {{roll= [[3d6!+@{char_endurance}+(@{enduranceTotal})]]}}"></button>
            <h5>Endurance Skills</h5>
            <fieldset class="repeating_enduranceExpertises">
                <input type="checkbox" name="attr_enduranceExpertiseActive" value="@{char_tier}">
                <input type="text" name="attr_enduranceExpertiseName" value="" placeholder="Expertise Name">
            </fieldset>

            <!-- Power Skills -->
            <button type="roll" name="roll_powerSkillCheck"
                value="&{template:rolls} {{title=Power Check}} {{subtitle=@{character_name} }} {{roll= [[3d6!+@{char_power}+(@{powerTotal})]]}}"></button>
            <h5>Power Skills</h5>
            <fieldset class="repeating_powerExpertises">
                <input type="checkbox" name="attr_powerExpertiseActive" value="@{char_tier}">
                <input type="text" name="attr_powerExpertiseName" value="" placeholder="Expertise Name">
            </fieldset>
        </div>






    </div>

    <!-- Notes Section - Now with Character Attributes & Notes -->
    <div class="notes">
        <h4>Character Attributes & Notes</h4>

        <div class="notes-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">

            <!-- Left Column: Character Attributes -->
            <div class="character-attributes">
                <h5>Character Attributes</h5>

                <div class="attribute-item" style="margin-bottom: 10px;">
                        <input type="checkbox" name="attr_char_swift" value="1">
                        <span>Swift (+½ Tier to Movement)</span>
                </div>

                <div class="attribute-item" style="margin-bottom: 10px;">
                        <input type="checkbox" name="attr_char_structure_vehicle" value="1">
                        <span>Structure / Vehicle</span>
                </div>

                <div class="attribute-item" style="margin-bottom: 10px;">
                        <span>Defensive Archetype (+2×Tier):</span>
                        <select name="attr_char_defensive_archetype" style="padding: 4px;">
                            <option value="none">None</option>
                            <option value="iron_will">Iron Will (Resolve)</option>
                            <option value="immovable">Immovable (Stability)</option>
                            <option value="resilient">Resilient (Vitality)</option>
                        </select>
                </div>
            </div>

            <!-- Right Column: Notes -->
            <div class="notes-column">
                <h5>Notes</h5>
                <fieldset class="repeating_notes">
                    <button type="roll" name="char_notes"
                        value="&{template:rolls} {{title=@{char_notes} }} {{subtitle=@{character_name} }} {{desc=@{notesDesc} }}"></button>
                    <input type="text" name="attr_char_notes" value="">
                    <details>
                        <textarea name="attr_notesDesc" value=""></textarea>
                    </details>
                </fieldset>
            </div>

        </div>
    </div>


    <!-- Attack Builder (v6.0: Updated attack types and conditions) -->

    <div class="other">
        <h4>Attack Building</h4>
        <p>In General, 0 is OFF and 1 is ON. For multi-tier abilities (Finishing Blow), enter tier number (1-3).</p>
        <fieldset class="repeating_attacks">
            <input type="text" name="attr_AttackName" value="" placeholder="Attack Name">
            <input type="text" name="attr_leftsub" value="" placeholder="Short Description">
            <details>
                <div class="attacks-grid">
                    <label>Type
                        <select name="attr_AttackType">
                            <option value="0">Melee (Accuracy)</option>
                            <option value="1">Melee (Damage & Conditions)</option>
                            <option value="2">Ranged</option>
                            <option value="3">Area</option>
                            <option value="4">Direct Condition</option>
                            <option value="5">Direct Area Condition</option>
                            <option value="6">Direct Damage</option>
                            <option value="7">Direct Area Damage</option>
                        </select>
                    </label>
                    <label>Roll CN
                        <select name="attr_RollCN">
                            <option value="0">OFF (Damage Only)</option>
                            <option value="1">Resolve</option>
                            <option value="2">Stability</option>
                            <option value="3">Vitality</option>
                        </select>
                    </label>
                </div>
                <div class="attacks-grid">
                    <label>Effect Type
                        <select name="attr_EffectType">
                            <option value="0">None (Damage Only)</option>
                            <option value="1">Brawl (Push/Prone/Grab)</option>
                            <option value="2">Frighten</option>
                            <option value="3">Taunt</option>
                            <option value="4">Charm</option>
                            <option value="5">Weaken</option>
                            <option value="6">Stun</option>
                            <option value="7">Control</option>
                        </select>
                    </label>
                </div>




                <!-- CRITICAL BONUSES -->
                <details>
                    <summary><h6>▼ Critical Bonuses</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Critical Accuracy<input type="number" name="attr_CriticalAccuracy" value="0"></label>
                        <label>Powerful Critical<input type="number" name="attr_PowerfulCritical" value="0"></label>
                        <label>Ricochet<input type="number" name="attr_Ricochet" value="0"></label>
                        <label>Double-Tap<input type="number" name="attr_DoubleTap" value="0"></label>
                        <label>Explosive Critical<input type="number" name="attr_ExplosiveCritical" value="0"></label>
                        <label>Martial Artist<input type="number" name="attr_MartialArtist" value="0"></label>
                    </div>
                </details>

                <!-- ACCURACY UPGRADES -->
                <details>
                    <summary><h6>▼ Accuracy Upgrades</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Accurate Attack<input type="number" name="attr_AccurateAttack" value="0"></label>
                        <label>Reliable Accuracy<input type="number" name="attr_ReliableAccuracy" value="0"></label>
                        <label>Overhit<input type="number" name="attr_Overhit" value="0"></label>
                    </div>
                </details>

                <!-- DAMAGE UPGRADES -->
                <details>
                    <summary><h6>▼ Damage Upgrades</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Power Attack<input type="number" name="attr_PowerAttack" value="0"></label>
                        <label>High Impact<input type="number" name="attr_HighImpact" value="0"></label>
                        <label>Critical Effect<input type="number" name="attr_CriticalEffect" value="0"></label>
                        <label>Armor Piercing<input type="number" name="attr_ArmorPiercing" value="0"></label>
                        <label>Brutal<input type="number" name="attr_Brutal" value="0"></label>
                        <label>Bleed<input type="number" name="attr_Bleed" value="0"></label>
                        <label>Shatter<input type="number" name="attr_Shatter" value="0"></label>
                        <label>Leech<input type="number" name="attr_Leech" value="0"></label>
                        <label>Finishing Blow (1-3)<input type="number" name="attr_FinishingBlow" value="0"></label>
                        <label>Culling Strike<input type="number" name="attr_CullingStrike" value="0"></label>
                    </div>
                </details>

                <!-- CONDITION UPGRADES -->
                <details>
                    <summary><h6>▼ Condition Upgrades</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Lasting Condition<input type="number" name="attr_LastingCondition" value="0"></label>
                        <label>Contagious<input type="number" name="attr_Contagious" value="0"></label>
                        <label>Reliable Condition<input type="number" name="attr_ReliableCondition" value="0"></label>
                        <label>Cursed<input type="number" name="attr_Cursed" value="0"></label>
                        <label>Overwhelming<input type="number" name="attr_OverwhelmingAffliction" value="0"></label>
                        <label>Concentration<input type="number" name="attr_Concentration" value="0"></label>
                        <label>Critical Condition<input type="number" name="attr_CriticalCondition" value="0"></label>
                        <label>Powerful Condition Critical<input type="number" name="attr_PowerfulConditionCritical" value="0"></label>
                    </div>
                </details>

                <!-- GENERIC ATTACK UPGRADES -->
                <details>
                    <summary><h6>▼ Generic Attack Upgrades</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Extended Range<input type="number" name="attr_ExtendedRange" value="0"></label>
                        <label>Long Range<input type="number" name="attr_LongRange" value="0"></label>
                        <label>Perception Range<input type="number" name="attr_PerceptionRange" value="0"></label>
                        <label>Enhanced Scale<input type="number" name="attr_EnhancedScale" value="0"></label>
                        <label>Precise<input type="number" name="attr_Precise" value="0"></label>
                        <label>Ranged Area<input type="number" name="attr_RangedArea" value="0"></label>
                    </div>
                </details>

                <!-- MELEE SPECIALIZED -->
                <details>
                    <summary><h6>▼ Melee Specialized</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Quick Strikes<input type="number" name="attr_QuickStrikes" 
                        <label>Barrage<input type="number" name="attr_Barrage" value="0"></label>
                        <label>Extra Attack<input type="number" name="attr_ExtraAttack" value="0"></label>
                    </div>
                </details>

                <!-- GENERAL SPECIALIZED -->
                <details>
                    <summary><h6>▼ General Specialized Combat</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Pounce<input type="number" name="attr_Pounce" value="0"></label>
                        <label>Splinter<input type="number" name="attr_Splinter" value="0"></label>
                        <label>Priority Target<input type="number" name="attr_PriorityTarget" value="0"></label>
                        <label>Bully<input type="number" name="attr_Bully" value="0"></label>
                        <label>Menacing<input type="number" name="attr_Menacing" value="0"></label>
                        <label>Disengage<input type="number" name="attr_Disengage" value="0"></label>
                        <label>Intimidating Presence<input type="number" name="attr_IntimidatingPresence" value="0"></label>
                        <label>Terrifying Display<input type="number" name="attr_TerrifyingDisplay" value="0"></label>
                    </div>
                </details>

                <!-- SLAYER UPGRADES -->
                <details>
                    <summary><h6>▼ Slayer Upgrades</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Minion Slayer<input type="number" name="attr_MinionSlayer" value="0"></label>
                        <label>Captain Slayer<input type="number" name="attr_CaptainSlayer" value="0"></label>
                        <label>Elite Slayer<input type="number" name="attr_EliteSlayer" value="0"></label>
                        <label>Boss Slayer<input type="number" name="attr_BossSlayer" value="0"></label>
                    </div>
                </details>

                <!-- SUSTAINED ATTACK -->
                <details>
                    <summary><h6>▼ Sustained Attack</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Channeled<input type="number" name="attr_Channeled" value="0"></label>
                        <label>Environmental<input type="number" name="attr_Environmental" value="0"></label>
                    </div>
                </details>

                <!-- LIMITS SECTION (v6.0: Entirely New System) -->

                <!-- Usage Limits -->
                <details>
                    <summary><h6>▼ Usage Limits</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Charges 1<input type="number" name="attr_Charges1" value="0"></label>
                        <label>Charges 2<input type="number" name="attr_Charges2" value="0"></label>
                    </div>
                </details>

                <!-- HP-Based Limits -->
                <details>
                    <summary><h6>▼ HP-Based Limits</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Timid<input type="number" name="attr_Timid" value="0"></label>
                        <label>Near Death<input type="number" name="attr_NearDeath" value="0"></label>
                        <label>Bloodied<input type="number" name="attr_Bloodied" value="0"></label>
                    </div>
                </details>

                <!-- Conditional Limits -->
                <details>
                    <summary><h6>▼ Conditional Limits</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Vengeful<input type="number" name="attr_Vengeful" value="0"></label>
                        <label>Revenge<input type="number" name="attr_RevengeLimit" value="0"></label>
                        <label>Unbreakable<input type="number" name="attr_Unbreakable" value="0"></label>
                        <label>Untouchable<input type="number" name="attr_Untouchable" value="0"></label>
                        <label>Avenger<input type="number" name="attr_AvengerLimit" value="0"></label>
                        <label>Passive<input type="number" name="attr_PassiveLimit" value="0"></label>
                        <label>Careful<input type="number" name="attr_Careful" value="0"></label>
                    </div>
                </details>

                <!-- Sequential Limits -->
                <details>
                    <summary><h6>▼ Sequential Limits</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Combo Move<input type="number" name="attr_ComboMove" value="0"></label>
                        <label>Infected<input type="number" name="attr_InfectedLimit" value="0"></label>
                        <label>Relentless<input type="number" name="attr_Relentless" value="0"></label>
                        <label>Slaughter<input type="number" name="attr_Slaughter" value="0"></label>
                    </div>
                </details>

                <!-- Positioning Limits -->
                <details>
                    <summary><h6>▼ Positioning Limits</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Rooted<input type="number" name="attr_Rooted" value="0"></label>
                        <label>Blitz<input type="number" name="attr_BlitzLimit" value="0"></label>
                        <label>Long Distance Fighter<input type="number" name="attr_LongDistanceFighter" value="0"></label>
                        <label>Dangerous<input type="number" name="attr_DangerousLimit" value="0"></label>
                    </div>
                </details>

                <!-- Random Limits -->
                <details>
                    <summary><h6>▼ Random Limits</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Unreliable 1 (DC 5)<input type="number" name="attr_Unreliable1" value="0"></label>
                        <label>Unreliable 2 (DC 10)<input type="number" name="attr_Unreliable2" value="0"></label>
                        <label>Unreliable 3 (DC 15)<input type="number" name="attr_Unreliable3" value="0"></label>
                    </div>
                </details>

                <!-- Time-Based Limits -->
                <details>
                    <summary><h6>▼ Time-Based Limits</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Quickdraw<input type="number" name="attr_Quickdraw" value="0"></label>
                        <label>Steady<input type="number" name="attr_Steady" value="0"></label>
                        <label>Patience<input type="number" name="attr_PatienceLimit" value="0"></label>
                        <label>Finale<input type="number" name="attr_Finale" value="0"></label>
                    </div>
                </details>

                <!-- Other Limits -->
                <details>
                    <summary><h6>▼ Other Limits</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Charge Up<input type="number" name="attr_ChargeUp" value="0"></label>
                        <label>Charge Up 2<input type="number" name="attr_ChargeUp2" value="0"></label>
                        <label>Exhausting<input type="number" name="attr_Exhausting" value="0"></label>
                        <label>Cooldown<input type="number" name="attr_Cooldown" value="0"></label>
                        <label>Attrition<input type="number" name="attr_Attrition" value="0"></label>
                        <label>Drain Reserves<input type="number" name="attr_DrainReserves" value="0"></label>
                        <label>Tower Defense<input type="number" name="attr_TowerDefenseLimit" value="0"></label>
                        <label>Compressed Release<input type="number" name="attr_CompressedReleaseLimit" value="0"></label>
                        <label>Domain<input type="number" name="attr_DomainLimit" value="0"></label>
                        <label>Grappler<input type="number" name="attr_GrapplerLimit" value="0"></label>
                        <label>Exploit<input type="number" name="attr_ExploitLimit" value="0"></label>
                    </div>
                </details>

                <!-- Sacrifice Limits -->
                <details>
                    <summary><h6>▼ Sacrifice Limits</h6></summary>
                    <div class="attacks-grid-compact">
                        <label>Sacrifice Minion<input type="number" name="attr_SacrificeMinion" value="0"></label>
                        <label>Sacrifice Captain<input type="number" name="attr_SacrificeCaptain" value="0"></label>
                        <label>Sacrifice Vanguard<input type="number" name="attr_SacrificeVanguard" value="0"></label>
                        <label>Sacrifice Boss<input type="number" name="attr_SacrificeBoss" value="0"></label>
                    </div>
                </details>

                <!-- String Modifiers -->
                <div class="bonuses-grid">
                    <label>Attack Details <input type="text" name="attr_AttackDetails" value=""></label>
                    <label>AC Mods <input type="text" name="attr_AccuracyStringModifiers" placeholder="Example: - [*S:char_tier] [AP]" value=""></label>
                    <label>DG Mods <input type="text" name="attr_DamageStringModifiers" placeholder="Example: + 5 [Domain]" value=""></label>
                    <label>CN Mods <input type="text" name="attr_ConditionsStringModifiers" placeholder="Example: + [*S:char_tier] [Domain]" value=""></label>
                </div>
            </details>
        </fieldset>






    </div>

    <!-- roll template -->

    <rolltemplate class="sheet-rolltemplate-rolls">
        <div class="sheet-container">
            <div class="sheet-header">
                {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
                {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
                {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
            </div>
            <div class="sheet-content">
                {{#allprops() title name subtitle desc}}
                <div class="sheet-key">{{key}}</div>
                <div class="sheet-value">{{value}}</div>
                {{/allprops() title name subtitle desc}}
                {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
            </div>
        </div>
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-custom">
        <div class="sheet-container">
            <div class="sheet-header">
                {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
                {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
                {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
            </div>
            <div class="sheet-content">
                {{#allprops() title name subtitle notes desc buttons}}
                <div class="sheet-key">{{key}}</div>
                <div class="sheet-value">{{value}}</div>
                {{/allprops() title name subtitle notes desc buttons}}
                {{#notes}}<div class="sheet-notes">{{notes}}</div>{{/notes}}
                {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
                {{#buttons}}<div class="sheet-buttons">{{buttons}}</div>{{/buttons}}
            </div>
        </div>
    </rolltemplate>


    <!-- Hide and Show Sections  -->
    <script type="text/worker">

            const buttonlist = ["combat","utility","other","notes"];
            buttonlist.forEach(button => {
                on(`clicked:${button}`, function() {
                    setAttrs({
                        sheet_tab: button
                    });
                });
            });
        </script>



    <script type="text/worker">

            // Define the skills that need totals calculated
            const skills = ['awareness', 'communication', 'intelligence', 'focus', 'mobility', 'endurance', 'power'];

            // Create a calculation function for each skill
            skills.forEach(skill => {
                // Create the event trigger string - note the corrected attribute reference
                const eventName = `change:repeating_${skill}Expertises:${skill}ExpertiseActive remove:repeating_${skill}Expertises sheet:opened`;

                on(eventName, function() {
                    getSectionIDs(`repeating_${skill}Expertises`, function(ids) {
                        if(!ids || ids.length === 0) {
                            setAttrs({
                                [`${skill}Total`]: 0
                            });
                            return;
                        }

                        // Get the tier value first
                        getAttrs(['char_tier'], function(tierValues) {
                            const tierValue = parseInt(tierValues.char_tier) || 0;

                            // Get all expertiseActive values for this skill
                            const fields = ids.map(id =>
                                `repeating_${skill}Expertises_${id}_${skill}ExpertiseActive`
                            );

                            getAttrs(fields, function(values) {
                                let total = 0;

                                // Sum up all active expertises
                                ids.forEach(id => {
                                    const checkboxValue = values[`repeating_${skill}Expertises_${id}_${skill}ExpertiseActive`];
                                    if(checkboxValue === "on" || checkboxValue === "@{char_tier}" || checkboxValue === "1") {
                                        total += tierValue;
                                    }
                                });

                                // Set the total for the skill
                                setAttrs({
                                    [`${skill}Total`]: total
                                });
                            });
                        });
                    });
                });
            });
        </script>

    <!-- NEW: Attack Deletion Handler -->
    <script type="text/worker">
        // Handle attack deletion - no totals to recalculate, but provides cleanup functionality
        on('remove:repeating_attacks sheet:opened', function() {
            // Currently no calculated values dependent on attacks
            // This handler ensures proper cleanup when attacks are deleted
            // Future: Add any attack-dependent calculations here
            console.log('Attack deleted - cleanup complete');
        });
    </script>



    <!-- Autocalculate   -->
    <script type="text/worker">


    // Define calculation configurations for each attribute (v6.0 Updated)
    const attributeCalculations = {
        char_avoidance: {
            base: 10, // v6.0: Avoidance = 10 + Tier + Mobility
            keys: ["char_tier", "char_avMod", "char_mobility"],
            weakenKey: "char_weakenAvoidance",
            primaryCheckbox: "char_avPrimaryAction", // Primary Action = TEMPORARY bonus
            bonusField: "traitAvBonus"
        },
        char_durability: {
            base: 5, // v6.0: Durability = 5 + Tier + Endurance
            keys: ["char_tier", "char_drMod", "char_endurance"],
            weakenKey: "char_weakenDurability",
            primaryCheckbox: "char_drPrimaryAction", // Primary Action = TEMPORARY bonus
            // v6.0: Removed multiplier and specificKey (no more 1.5× Endurance)
            bonusField: "traitDrBonus"
        },
        char_resolve: {
            base: 10,
            keys: ["char_tier", "char_rsMod", "char_focus", "char_defensive_archetype"],
            weakenKey: "char_weakenAllResistance",
            primaryCheckbox: "char_rsPrimaryAction", // Primary Action = TEMPORARY bonus
            bonusField: "traitRsBonus"
        },
        char_stability: {
            base: 10,
            keys: ["char_tier", "char_sbMod", "char_power", "char_defensive_archetype"],
            weakenKey: "char_weakenAllResistance",
            primaryCheckbox: "char_sbPrimaryAction", // Primary Action = TEMPORARY bonus
            bonusField: "traitSbBonus"
        },
        char_vitality: {
            base: 10,
            keys: ["char_tier", "char_vtMod", "char_endurance", "char_defensive_archetype"],
            weakenKey: "char_weakenAllResistance",
            primaryCheckbox: "char_vtPrimaryAction", // Primary Action = TEMPORARY bonus
            bonusField: "traitVtBonus"
        },
        char_accuracy: {
            base: 0,
            keys: ["char_tier", "char_acMod", "char_focus"],
            weakenKey: "char_weakenAccuracy",
            primaryCheckbox: "char_acPrimaryAction", // Primary Action = TEMPORARY bonus
            bonusField: "traitAcBonus"
        },
        char_damage: {
            base: 0,
            keys: ["char_tier", "char_dgMod", "char_power"],
            weakenKey: "char_weakenDamage",
            primaryCheckbox: "char_dgPrimaryAction", // Primary Action = TEMPORARY bonus
            // v6.0: Removed multiplier and specificKey (no more 1.5× Power)
            bonusField: "traitDgBonus"
        },
        char_conditions: {
            base: 0,
            keys: ["char_tier", "char_cnMod", "char_power"],
            weakenKey: "char_weakenConditions",
            primaryCheckbox: "char_cnPrimaryAction", // Primary Action = TEMPORARY bonus
            bonusField: "traitCnBonus"
        },
        char_initiative: {
            base: 0,
            keys: ["char_tier", "char_mobility", "char_focus", "char_awareness", "char_initiativeMod"],
            primaryCheckbox: "char_initiativePrimaryAction" // Primary Action = TEMPORARY bonus
        }
    };

    // Generic handler function for attribute calculation (v6.0: Primary Actions = TEMPORARY bonuses)
    const calculateAttribute = (attrKey, config) => {
        const eventKeys = [
            ...config.keys.map(key => `change:${key}`),
            `change:${config.weakenKey}`,
            `change:${config.primaryCheckbox}`,
            "change:char_efforts_used",
            "sheet:opened",
            "change:repeating_traits remove:repeating_traits"
        ].join(" ");

        on(eventKeys, function () {
            const requiredKeys = [
                ...config.keys,
                config.weakenKey,
                config.primaryCheckbox,
                "char_efforts_used"
            ];

            getAttrs(requiredKeys, function (values) {
                let total = config.base;
                const tier = parseInt(values.char_tier) || 0;

                // Add static keys (v6.0: No more multiplier system)
                total += config.keys.reduce((sum, key) => {
                    // Skip char_defensive_archetype in sum, we'll handle it separately
                    if (key === "char_defensive_archetype") return sum;
                    return sum + (parseInt(values[key]) || 0);
                }, 0);

                // Add Defensive Archetype bonus (2×Tier to appropriate stat)
                const defensiveArchetype = values.char_defensive_archetype;
                if (defensiveArchetype && defensiveArchetype !== "none") {
                    if ((attrKey === "char_resolve" && defensiveArchetype === "iron_will") ||
                        (attrKey === "char_stability" && defensiveArchetype === "immovable") ||
                        (attrKey === "char_vitality" && defensiveArchetype === "resilient")) {
                        total += (2 * tier);
                    }
                }

                // Add bonuses from repeating traits
                getSectionIDs("repeating_traits", ids => {
                    if (!ids || ids.length === 0) {
                        // Complete calculation without traits
                        if (config.weakenKey) {
                            total -= parseInt(values[config.weakenKey]) || 0;
                        }
                        // Subtract efforts used penalty
                        total -= parseInt(values.char_efforts_used) || 0;
                        // Add Primary Action bonus (TEMPORARY)
                        if (values[config.primaryCheckbox] === "on") {
                            total += tier;
                        }
                        total = Math.ceil(total);
                        setAttrs({ [attrKey]: total });
                        return;
                    }

                    const fields = ids.flatMap(id => [
                        `repeating_traits_${id}_traitActive`,
                        `repeating_traits_${id}_${config.bonusField}`
                    ]);

                    getAttrs(fields, traitValues => {
                        ids.forEach(id => {
                            if (traitValues[`repeating_traits_${id}_traitActive`] === "1") {
                                total += parseInt(traitValues[`repeating_traits_${id}_${config.bonusField}`]) || 0;
                            }
                        });

                        // Subtract weaken key if present
                        if (config.weakenKey) {
                            total -= parseInt(values[config.weakenKey]) || 0;
                        }

                        // Subtract efforts used penalty
                        total -= parseInt(values.char_efforts_used) || 0;

                        // Add Primary Action bonus (TEMPORARY - until start of next turn)
                        if (values[config.primaryCheckbox] === "on") {
                            total += tier;
                        }

                        // Round up the final total
                        total = Math.ceil(total);

                        setAttrs({ [attrKey]: total });
                    });
                });
            });
        });
    };

    // Special movement calculation (v6.0: New formula - Mobility + 2×Tier)
    on('change:char_tier change:char_mobility change:char_movementMod change:char_swift change:char_weakenMovement change:char_movementPrimaryAction change:char_efforts_used sheet:opened change:repeating_traits remove:repeating_traits', function () {
        const requiredKeys = ["char_tier", "char_mobility", "char_movementMod", "char_swift", "char_weakenMovement", "char_movementPrimaryAction", "char_efforts_used"];

        getAttrs(requiredKeys, function (values) {
            const tier = parseInt(values.char_tier) || 0;
            const mobility = parseInt(values.char_mobility) || 0;

            // v6.0: Base movement: Mobility + (2 × Tier)
            let total = mobility + (2 * tier);

            // Add movement modifier
            total += (parseInt(values.char_movementMod) || 0);

            // Add Swift bonus (+½ Tier, rounded up)
            if (values.char_swift === "1") {
                total += Math.ceil(tier / 2);
            }

            // Handle traits (same pattern as generic function)
            getSectionIDs("repeating_traits", ids => {
                if (!ids || ids.length === 0) {
                    // Complete calculation without traits
                    total -= (parseInt(values.char_weakenMovement) || 0);
                    // Subtract efforts used penalty
                    total -= (parseInt(values.char_efforts_used) || 0);
                    // Add Primary Action bonus (TEMPORARY - Steady action)
                    if (values.char_movementPrimaryAction === "on") {
                        total += tier;
                    }
                    setAttrs({ char_movement: total });
                    return;
                }

                const fields = ids.flatMap(id => [
                    `repeating_traits_${id}_traitActive`,
                    `repeating_traits_${id}_traitMBonus`
                ]);

                getAttrs(fields, traitValues => {
                    ids.forEach(id => {
                        if (traitValues[`repeating_traits_${id}_traitActive`] === "1") {
                            total += parseInt(traitValues[`repeating_traits_${id}_traitMBonus`]) || 0;
                        }
                    });

                    total -= (parseInt(values.char_weakenMovement) || 0);
                    // Subtract efforts used penalty
                    total -= (parseInt(values.char_efforts_used) || 0);
                    // Add Primary Action bonus (TEMPORARY - Steady action)
                    if (values.char_movementPrimaryAction === "on") {
                        total += tier;
                    }

                    setAttrs({ char_movement: total });
                });
            });
        });
    });

    // Initialize calculations for each attribute
    Object.entries(attributeCalculations).forEach(([attrKey, config]) => calculateAttribute(attrKey, config));

</script>


</main>