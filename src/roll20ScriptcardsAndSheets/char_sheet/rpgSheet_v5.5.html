<main>

    <!-- Header  -->
    <div class="header">
        <h4>Hero Name </h4>
        <h4>Real Name </h4>
        <h5>Character Tier </h5>
        <h5>Efforts </h5>
        <h5>Destiny </h5>

        <input type="text" name="attr_character_name">
        <input type="text" name="attr_character_realname">
        <input type="number" name="attr_char_tier" value="4">
        <input type="number" name="attr_char_efforts" value="2">
        <button type="roll" name="char_destiny"
            value="&{template:rolls} {{title=Destiny}} {{subtitle=@{character_name} }} {{DC ?{DC?} = [[d100]]}}"></button>
    </div>


    <!-- Character Basics Section  -->
    <div class="basics">
        <!-- Stats  -->

        <div class="stats">
            <h5>Core Stats</h5>
            <h5>Score</h5>

            <span>Focus</span>
            <input type="number" name="attr_char_focus" value="0">

            <span>Mobility</span>
            <input type="number" name="attr_char_mobility" value="0">

            <span>Power</span>
            <input type="number" name="attr_char_power" value="0">

            <span>Endurance</span>
            <input type="number" name="attr_char_endurance" value="0">

            <span>Awareness</span>
            <input type="number" name="attr_char_awareness" value="0">

            <span>Communication</span>
            <input type="number" name="attr_char_communication" value="0">

            <span>Intelligence</span>
            <input type="number" name="attr_char_intelligence" value="0">
        </div>

        <!-- Defenses  -->
        <div class="defenses">
            <h5>Stats</h5>
            <h5>Score</h5>
            <h5>Mod</h5>
            <h5>Primary Action</h5>


            <span>Avoidance</span>
            <input type="number" name="attr_display_avoidance" value="@{char_avoidance}" disabled="true">
            <input type="number" name="attr_char_avMod" value="0">
            <input type="checkbox" name="attr_char_avPrimaryAction">

            <span>Durability</span>
            <input type="number" name="attr_display_durability" value="@{char_durability}" disabled="true">
            <input type="number" name="attr_char_drMod" value="0">
            <input type="checkbox" name="attr_char_drPrimaryAction">

            <span>Resolve</span>
            <input type="number" name="attr_display_resolve" value="@{char_resolve}" disabled="true">
            <input type="number" name="attr_char_rsMod" value="0">
            <input type="checkbox" name="attr_char_rsPrimaryAction">

            <span>Stability</span>
            <input type="number" name="attr_display_stability" value="(@{char_stability})" disabled="true">
            <input type="number" name="attr_char_sbMod" value="0">
            <input type="checkbox" name="attr_char_sbPrimaryAction">

            <span>Vitality</span>
            <input type="number" name="attr_display_vitality" value="@{char_vitality}" disabled="true">
            <input type="number" name="attr_char_vtMod" value="0">
            <input type="checkbox" name="attr_char_vtPrimaryAction">

            <span>Survival Check</span>
            <input type="number" class="invisible-preserve-layout" disabled="true">
            <input type="number" class="invisible-preserve-layout" disabled="true">
            <button type="roll" name="char_survival_check"
                value="&{template:rolls} {{title=Survival Check}} {{subtitle=@{character_name}}} {{consciousness=DC [[@{char_hp}*-1]]}} {{death=DC [[@{char_hp}*-1-20]]}} {{roll=[[d20]]}}"></button>
        </div>


        <!-- Settings  -->

        <div class="settings">

            <h5>Stats</h5>
            <h5>Score</h5>
            <h5>Mod</h5>
            <h5>Primary Action</h5>



            <span>Movement</span>
            <input type="number" name="attr_display_movement" value="@{char_movement}" disabled="true">
            <input type="number" name="attr_char_movementMod" value="0">
            <input type="checkbox" name="attr_char_movementPrimaryAction">

            <span>Accuracy</span>
            <input type="number" name="attr_display_accuracy" value="@{char_accuracy}" disabled="true">
            <input type="number" name="attr_char_acMod" value="0">
            <input type="checkbox" name="attr_char_acPrimaryAction">

            <span>Damage</span>
            <input type="number" name="attr_display_damage" value="@{char_damage}" disabled="true">
            <input type="number" name="attr_char_dgMod" value="0">
            <input type="checkbox" name="attr_char_dgPrimaryAction">

            <span>Conditions</span>
            <input type="number" name="attr_display_conditions" value="@{char_conditions}" disabled="true">
            <input type="number" name="attr_char_cnMod" value="0">
            <input type="checkbox" name="attr_char_cnPrimaryAction">

            <span>Initiative</span>
            <input type="number" name="attr_display_initiative" value="@{char_initiative}" disabled="true">
            <input type="number" name="attr_char_initiativeMod" value="0">
            <input type="number" class="invisible-preserve-layout" disabled="true">

            <span>Hit Points</span>
            <input type="number" name="attr_char_hp" value="100">
            <input type="number" name="attr_char_hp_max" value="100">

        </div>

    </div>





    <!-- Hide and Show Sections  -->

    <input type="hidden" name="attr_sheet_tab" class="tabs" value="character">
    <div class="buttons">
        <button type="action" name="act_combat">Combat</button>
        <button type="action" name="act_utility">Utility</button>
        <button type="action" name="act_other">Attack Building</button>
        <button type="action" name="act_notes">Notes</button>

    </div>



    <!-- Combat Classes  -->

    <div class="combat">


        <div class="traits">
            <h4>Traits</h4>
            <!-- Repeating Section -->
            <fieldset class="repeating_traits">
                <input type="checkbox" name="attr_traitActive" value="1">
                <input type="text" name="attr_traitName" value="" placeholder="Trait Name">
                <details>
                    <div class="bonuses-grid">
                        <label>AC Mod <input type="number" name="attr_traitAcBonus" value="0"></label>
                        <label>DG Mod <input type="number" name="attr_traitDgBonus" value="0"></label>
                        <label>CN Mod <input type="number" name="attr_traitCnBonus" value="0"></label>
                        <label>AV Mod <input type="number" name="attr_traitAvBonus" value="0"></label>
                        <label>DR Mod <input type="number" name="attr_traitDrBonus" value="0"></label>
                        <label>RS Mod <input type="number" name="attr_traitRsBonus" value="0"></label>
                        <label>SB Mod <input type="number" name="attr_traitSbBonus" value="0"></label>
                        <label>VT Mod <input type="number" name="attr_traitVtBonus" value="0"></label>
                        <label>M Mod <input type="number" name="attr_traitMBonus" value="0"></label>
                    </div>
                </details>
            </fieldset>




        </div>

        <div class="uniques">
            <h4>Unique Powers</h4>
            <fieldset class="repeating_uniqueAbilities">
                <button type="roll" name="char_uniqueAbilities"
                    value="&{template:rolls} {{title=@{char_uniqueAbilities} }} {{subtitle=@{character_name} }} {{desc=@{uniqueAbilitiesDesc} }}"></button>
                <input type="text" name="attr_char_uniqueAbilities" value="">
                <details>
                    <textarea name="attr_uniqueAbilitiesDesc" value=""></textarea>
                </details>
            </fieldset>
        </div>



    </div>



    <!-- Utility Classes  -->

    <div class="utility">


        <div class="features">
            <h4>Features, Descriptors and Senses</h4>
            <fieldset class="repeating_features">
                <button type="roll" name="char_features"
                    value="&{template:rolls} {{title=@{char_features} }} {{subtitle=@{character_name} }} {{desc=@{featuresDesc} }}"></button>
                <input type="text" name="attr_char_features" value="">
                <details>
                    <textarea name="attr_featuresDesc" value=""></textarea>
                </details>
            </fieldset>
        </div>



        <div class="expertises">
            <h4>Expertise</h4>

            <!-- Awareness Skills -->
            <button type="roll" name="roll_awarenessSkillCheck"
                value="&{template:rolls} {{title=Awareness Check}} {{subtitle=@{character_name} }} {{roll= [[3d6!+@{char_awareness}+@{awarenessTotal}]]}}"></button>
            <h5>Awareness Skills</h5>
            <fieldset class="repeating_awarenessExpertises">
                <input type="checkbox" name="attr_awarenessExpertiseActive">
                <input type="text" name="attr_awarenessExpertiseName" placeholder="Expertise Name">
            </fieldset>

            <!-- Communication Skills -->
            <button type="roll" name="roll_communicationSkillCheck"
                value="&{template:rolls} {{title=Communication Check}} {{subtitle=@{character_name} }} {{roll= [[3d6!+@{char_communication}+(@{communicationTotal})]]}}"></button>
            <h5>Communication Skills</h5>
            <fieldset class="repeating_communicationExpertises">
                <input type="checkbox" name="attr_communicationExpertiseActive" value="@{char_tier}">
                <input type="text" name="attr_communicationExpertiseName" value="" placeholder="Expertise Name">
            </fieldset>

            <!-- Intelligence Skills -->
            <button type="roll" name="roll_intelligenceSkillCheck"
                value="&{template:rolls} {{title=Intelligence Check}} {{subtitle=@{character_name} }} {{roll= [[3d6!+@{char_intelligence}+(@{intelligenceTotal})]]}}"></button>
            <h5>Intelligence Skills</h5>
            <fieldset class="repeating_intelligenceExpertises">
                <input type="checkbox" name="attr_intelligenceExpertiseActive" value="@{char_tier}">
                <input type="text" name="attr_intelligenceExpertiseName" value="" placeholder="Expertise Name">
            </fieldset>

            <!-- Focus Skills -->
            <button type="roll" name="roll_focusSkillCheck"
                value="&{template:rolls} {{title=Focus Check}} {{subtitle=@{character_name} }} {{roll= [[3d6!+@{char_focus}+(@{focusTotal})]]}}"></button>
            <h5>Focus Skills</h5>
            <fieldset class="repeating_focusExpertises">
                <input type="checkbox" name="attr_focusExpertiseActive" value="@{char_tier}">
                <input type="text" name="attr_focusExpertiseName" value="" placeholder="Expertise Name">
            </fieldset>

            <!-- Mobility Skills -->
            <button type="roll" name="roll_mobilitySkillCheck"
                value="&{template:rolls} {{title=Mobility Check}} {{subtitle=@{character_name} }} {{roll= [[3d6!+@{char_mobility}+(@{mobilityTotal})]]}}"></button>
            <h5>Mobility Skills</h5>
            <fieldset class="repeating_mobilityExpertises">
                <input type="checkbox" name="attr_mobilityExpertiseActive" value="@{char_tier}">
                <input type="text" name="attr_mobilityExpertiseName" value="" placeholder="Expertise Name">
            </fieldset>

            <!-- Endurance Skills -->
            <button type="roll" name="roll_enduranceSkillCheck"
                value="&{template:rolls} {{title=Endurance Check}} {{subtitle=@{character_name} }} {{roll= [[3d6!+@{char_endurance}+(@{enduranceTotal})]]}}"></button>
            <h5>Endurance Skills</h5>
            <fieldset class="repeating_enduranceExpertises">
                <input type="checkbox" name="attr_enduranceExpertiseActive" value="@{char_tier}">
                <input type="text" name="attr_enduranceExpertiseName" value="" placeholder="Expertise Name">
            </fieldset>

            <!-- Power Skills -->
            <button type="roll" name="roll_powerSkillCheck"
                value="&{template:rolls} {{title=Power Check}} {{subtitle=@{character_name} }} {{roll= [[3d6!+@{char_power}+(@{powerTotal})]]}}"></button>
            <h5>Power Skills</h5>
            <fieldset class="repeating_powerExpertises">
                <input type="checkbox" name="attr_powerExpertiseActive" value="@{char_tier}">
                <input type="text" name="attr_powerExpertiseName" value="" placeholder="Expertise Name">
            </fieldset>
        </div>






    </div>

    <!-- Notes Section - Now with Character Attributes & Notes -->
    <div class="notes">
        <h4>Character Attributes & Notes</h4>
        
        <div class="notes-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
            
            <!-- Left Column: Character Attributes -->
            <div class="character-attributes">
                <h5>Character Attributes</h5>
                
                <div class="attribute-item" style="margin-bottom: 10px;">
                        <input type="checkbox" name="attr_char_swift" value="1">
                        <span>Swift (+½ Tier to Movement)</span>
                </div>
                
                <div class="attribute-item" style="margin-bottom: 10px;">
                        <input type="checkbox" name="attr_char_structure_vehicle" value="1">
                        <span>Structure / Vehicle</span>
                </div>
                
                <div class="attribute-item" style="margin-bottom: 10px;">
                        <span>Resistance Type:</span>
                        <select name="attr_char_resistance_type" style="padding: 4px;">
                            <option value="none">None</option>
                            <option value="physical">Physical</option>
                            <option value="energy">Energy</option>
                            <option value="other">Other</option>
                        </select>
                </div>
            </div>
            
            <!-- Right Column: Notes -->
            <div class="notes-column">
                <h5>Notes</h5>
                <fieldset class="repeating_notes">
                    <button type="roll" name="char_notes"
                        value="&{template:rolls} {{title=@{char_notes} }} {{subtitle=@{character_name} }} {{desc=@{notesDesc} }}"></button>
                    <input type="text" name="attr_char_notes" value="">
                    <details>
                        <textarea name="attr_notesDesc" value=""></textarea>
                    </details>
                </fieldset>
            </div>
            
        </div>
    </div>


    <!-- other or Settings or Attack Builder  -->

    <div class="other">
        <h4>Attack Building</h4>
        <p>In General, 0 is OFF and 1 is ON, for abilities like finishing blow which has multiple tiers, put the number
            of Tiers. For Slayer Upgrades, 1 is AC, 2 is DG and 3 is CN.</p>
        <fieldset class="repeating_attacks">
            <input type="text" name="attr_AttackName" value="" placeholder="Attack Name">
            <input type="text" name="attr_leftsub" value="" placeholder="Short Description">
            <details>
                <div class="attacks-grid">
                    <label>Type
                        <select name="attr_AttackType">
                            <option value="0">Melee (AC)</option>
                            <option value="1">Melee (DG/CN)</option>
                            <option value="2">Ranged</option>
                            <option value="3">Direct</option>
                            <option value="4">AOE</option>
                            <option value="5">AOE Direct</option>
                        </select>
                    </label>
                    <label>Roll CN
                        <select name="attr_RollCN">
                            <option value="0">OFF</option>
                            <option value="1">Resolve</option>
                            <option value="2">Stability</option>
                            <option value="3">Vitality</option>
                        </select>
                    </label>
                </div>
                <div class="attacks-grid">
                    <label>Effect Type
                        <select name="attr_EffectType">
                            <option value="0">None</option>
                            <option value="1">Disarm</option>
                            <option value="2">Grab</option>
                            <option value="3">Shove</option>
                            <option value="4">Daze</option>
                            <option value="5">Blind</option>
                            <option value="6">Taunt</option>
                            <option value="7">Setup</option>
                            <option value="8">Control</option>
                            <option value="9">Stun</option>
                            <option value="10">Weaken</option>
                            <option value="11">Disable Specials</option>
                        </select>
                    </label>
                    <label>Hybrid
                        <select name="attr_Hybrid">
                            <option value="0">OFF</option>
                            <option value="1">Damage → CN</option>
                            <option value="2">CN → Damage</option>
                        </select>
                    </label>
                </div>




                <!-- ACCURACY BONUSES -->
                <div class="attacks-grid-compact">
                    <label>Accurate <input type="number" name="attr_AccurateAttack" value="0"></label>
                    <label>Reliable AC <input type="number" name="attr_ReliableAccuracy" value="0"></label>
                    <label>Crit AC <input type="number" name="attr_AccuracyCriticalRange" value="0"></label>
                    <label>Powerful Crit <input type="number" name="attr_PowerfulCritical" value="0"></label>
                    <label>Overhit <input type="number" name="attr_Overhit" value="0"></label>
                    <label>Blitz <input type="number" name="attr_Blitz" value="0"></label>
                    <label>Ricochet <input type="number" name="attr_Ricochet" value="0"></label>
                    <label>Double-Tap <input type="number" name="attr_DoubleTap" value="0"></label>
                    <label>Explosive Crit <input type="number" name="attr_ExplosiveCritical" value="0"></label>
                </div>

                <!-- DAMAGE BONUSES -->
                <div class="attacks-grid-compact">
                    <label>Power Attack <input type="number" name="attr_PowerAttack" value="0"></label>
                    <label>High Impact <input type="number" name="attr_HighImpact" value="0"></label>
                    <label>Enhanced Effect <input type="number" name="attr_EnhancedEffect" value="0"></label>
                    <label>Reliable Effect <input type="number" name="attr_ReliableEffect" value="0"></label>
                    <label>Consistent <input type="number" name="attr_ConsistentEffect" value="0"></label>
                    <label>Crit Effect <input type="number" name="attr_CriticalEffect" value="0"></label>
                    <label>Armor Pierce <input type="number" name="attr_ArmorPiercing" value="0"></label>
                    <label>Brutal <input type="number" name="attr_Brutal" value="0"></label>
                    <label>Splash <input type="number" name="attr_SplashDamage" value="0"></label>
                    <label>Bleed <input type="number" name="attr_Bleed" value="0"></label>
                    <label>Environmental <input type="number" name="attr_Environmental" value="0"></label>
                    <label>Shatter <input type="number" name="attr_Shatter" value="0"></label>
                    <label>Leech <input type="number" name="attr_Leech" value="0"></label>
                    <label>Finishing <input type="number" name="attr_FinishingBlow" value="0"></label>
                    <label>Culling <input type="number" name="attr_CullingStrike" value="0"></label>
                </div>

                <!-- CONDITION BONUSES -->
                <div class="attacks-grid-compact">
                    <label>Crit CN <input type="number" name="attr_ConditionCriticalRange" value="0"></label>
                    <label>Lasting Cond. <input type="number" name="attr_LastingCondition" value="0"></label>
                    <label>Mass Effect <input type="number" name="attr_MassEffect" value="0"></label>
                    <label>Collateral <input type="number" name="attr_CollateralCondition" value="0"></label>
                    <label>Contagious <input type="number" name="attr_Contagious" value="0"></label>
                    <label>Cursed <input type="number" name="attr_Cursed" value="0"></label>
                    <label>Overwhelming <input type="number" name="attr_OverwhelmingAffliction" value="0"></label>
                </div>

                <!-- MELEE SPECIALIZED -->
                <div class="attacks-grid-compact">
                    <label>Heavy Strike <input type="number" name="attr_HeavyStrike" value="0"></label>
                    <label>Quick Strikes <input type="number" name="attr_QuickStrikes" value="0"></label>
                    <label>Whirlwind Strike <input type="number" name="attr_WhirlwindStrike" value="0"></label>
                </div>

                <!-- RANGED SPECIALIZED -->
                <div class="attacks-grid-compact">
                    <label>Headshot <input type="number" name="attr_Headshot" value="0"></label>
                    <label>Barrage <input type="number" name="attr_Barrage" value="0"></label>
                    <label>Scatter Shot <input type="number" name="attr_ScatterShot" value="0"></label>
                </div>

                <!-- GENERAL SPECIALIZED -->
                <div class="attacks-grid-compact">
                    <label>Flurry <input type="number" name="attr_FlurryOfBlows" value="0"></label>
                    <label>Pounce <input type="number" name="attr_Pounce" value="0"></label>
                    <label>Splinter <input type="number" name="attr_Splinter" value="0"></label>
                    <label>Analyzing <input type="number" name="attr_AnalyzingStrike" value="0"></label>
                    <label>Follow-Up <input type="number" name="attr_FollowUpStrike" value="0"></label>
                    <label>Counter <input type="number" name="attr_Counterattack" value="0"></label>
                    <label>Exploit <input type="number" name="attr_Exploit" value="0"></label>
                    <label>Priority <input type="number" name="attr_PriorityTarget" value="0"></label>
                    <label>Bully <input type="number" name="attr_Bully" value="0"></label>
                    <label>Martial <input type="number" name="attr_MartialArtist" value="0"></label>
                    <label>Grappler <input type="number" name="attr_Grappler" value="0"></label>
                    <label>Menacing <input type="number" name="attr_Menacing" value="0"></label>
                    <label>Disengage <input type="number" name="attr_Disengage" value="0"></label>
                    <label>Extra Attack <input type="number" name="attr_ExtraAttack" value="0"></label>
                </div>

                <!-- SLAYER UPGRADES -->
                <div class="attacks-grid-compact">
                    <label>Minion <input type="number" name="attr_MinionSlayer" value="0"></label>
                    <label>Captain <input type="number" name="attr_CaptainSlayer" value="0"></label>
                    <label>Elite <input type="number" name="attr_EliteSlayer" value="0"></label>
                    <label>Boss <input type="number" name="attr_BossSlayer" value="0"></label>
                </div>

                <!-- VARIABLE BONUSES -->
                <div class="attacks-grid-compact">
                    <label>Lucky <input type="number" name="attr_LuckyStrike" value="0"></label>
                    <label>Compressed <input type="number" name="attr_CompressedRelease" value="0"></label>
                    <label>Domain <input type="number" name="attr_Domain" value="0"></label>
                    <label>Tower <input type="number" name="attr_TowerDefense" value="0"></label>
                    <label>Channeled <input type="number" name="attr_Channeled" value="0"></label>
                    <label>Focused <input type="number" name="attr_Focused" value="0"></label>
                </div>




                <!-- String Modifiers -->
                <div class="bonuses-grid">
                    <label>Attack Details <input type="text" name="attr_AttackDetails" value=""></label>
                    <label>AC Mods <input type="text" name="attr_AccuracyStringModifiers" placeholder="Example: - [*S:char_tier] [AP]" value=""></label>
                    <label>DG Mods <input type="text" name="attr_DamageStringModifiers" placeholder="Example: + 5 [Domain]" value=""></label>
                    <label>CN Mods <input type="text" name="attr_ConditionsStringModifiers" placeholder="Example: + [*S:char_tier] [Domain]" value=""></label>
                </div>
            </details>
        </fieldset>






    </div>

    <!-- roll template -->

    <rolltemplate class="sheet-rolltemplate-rolls">
        <div class="sheet-container">
            <div class="sheet-header">
                {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
                {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
                {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
            </div>
            <div class="sheet-content">
                {{#allprops() title name subtitle desc}}
                <div class="sheet-key">{{key}}</div>
                <div class="sheet-value">{{value}}</div>
                {{/allprops() title name subtitle desc}}
                {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
            </div>
        </div>
    </rolltemplate>

    <rolltemplate class="sheet-rolltemplate-custom">
        <div class="sheet-container">
            <div class="sheet-header">
                {{#title}}<div class="sheet-title">{{title}}</div>{{/title}}
                {{#name}}<div class="sheet-name">{{name}}</div>{{/name}}
                {{#subtitle}}<div class="sheet-subtitle">{{subtitle}}</div>{{/subtitle}}
            </div>
            <div class="sheet-content">
                {{#allprops() title name subtitle notes desc buttons}}
                <div class="sheet-key">{{key}}</div>
                <div class="sheet-value">{{value}}</div>
                {{/allprops() title name subtitle notes desc buttons}}
                {{#notes}}<div class="sheet-notes">{{notes}}</div>{{/notes}}
                {{#desc}}<div class="sheet-desc">{{desc}}</div>{{/desc}}
                {{#buttons}}<div class="sheet-buttons">{{buttons}}</div>{{/buttons}}
            </div>
        </div>
    </rolltemplate>


    <!-- Hide and Show Sections  -->
    <script type="text/worker">

            const buttonlist = ["combat","utility","other","notes"];
            buttonlist.forEach(button => {
                on(`clicked:${button}`, function() {
                    setAttrs({
                        sheet_tab: button
                    });
                });
            });
        </script>



    <script type="text/worker">

            // Define the skills that need totals calculated
            const skills = ['awareness', 'communication', 'intelligence', 'focus', 'mobility', 'endurance', 'power'];

            // Create a calculation function for each skill
            skills.forEach(skill => {
                // Create the event trigger string - note the corrected attribute reference
                const eventName = `change:repeating_${skill}Expertises:${skill}ExpertiseActive remove:repeating_${skill}Expertises sheet:opened`;

                on(eventName, function() {
                    getSectionIDs(`repeating_${skill}Expertises`, function(ids) {
                        if(!ids || ids.length === 0) {
                            setAttrs({
                                [`${skill}Total`]: 0
                            });
                            return;
                        }

                        // Get the tier value first
                        getAttrs(['char_tier'], function(tierValues) {
                            const tierValue = parseInt(tierValues.char_tier) || 0;

                            // Get all expertiseActive values for this skill
                            const fields = ids.map(id =>
                                `repeating_${skill}Expertises_${id}_${skill}ExpertiseActive`
                            );

                            getAttrs(fields, function(values) {
                                let total = 0;

                                // Sum up all active expertises
                                ids.forEach(id => {
                                    const checkboxValue = values[`repeating_${skill}Expertises_${id}_${skill}ExpertiseActive`];
                                    if(checkboxValue === "on" || checkboxValue === "@{char_tier}" || checkboxValue === "1") {
                                        total += tierValue;
                                    }
                                });

                                // Set the total for the skill
                                setAttrs({
                                    [`${skill}Total`]: total
                                });
                            });
                        });
                    });
                });
            });
        </script>

    <!-- NEW: Attack Deletion Handler -->
    <script type="text/worker">
        // Handle attack deletion - no totals to recalculate, but provides cleanup functionality
        on('remove:repeating_attacks sheet:opened', function() {
            // Currently no calculated values dependent on attacks
            // This handler ensures proper cleanup when attacks are deleted
            // Future: Add any attack-dependent calculations here
            console.log('Attack deleted - cleanup complete');
        });
    </script>



    <!-- Autocalculate   -->
    <script type="text/worker">


    // Define calculation configurations for each attribute
    const attributeCalculations = {
        char_avoidance: {
            base: 10,
            keys: ["char_tier", "char_avMod", "char_mobility"],
            weakenKey: "char_weakenAvoidance",
            primaryCheckbox: "char_avPrimaryAction",
            bonusField: "traitAvBonus" // Specify which bonus field to sum
        },
        char_durability: {
            base: 0,
            keys: ["char_tier", "char_drMod", "char_endurance"],
            weakenKey: "char_weakenDurability",
            multiplier: 1.5,
            specificKey: "char_endurance",
            primaryCheckbox: "char_drPrimaryAction",
            bonusField: "traitDrBonus"

        },
        char_resolve: {
            base: 10,
            keys: ["char_tier", "char_rsMod", "char_focus"],
            weakenKey: "char_weakenAllResistance",
            primaryCheckbox: "char_rsPrimaryAction",
            bonusField: "traitRsBonus"
        },
        char_stability: {
            base: 10,
            keys: ["char_tier", "char_sbMod", "char_power"],
            weakenKey: "char_weakenAllResistance",
            primaryCheckbox: "char_sbPrimaryAction",
            bonusField: "traitSbBonus"
        },
        char_vitality: {
            base: 10,
            keys: ["char_tier", "char_vtMod", "char_endurance"],
            weakenKey: "char_weakenAllResistance",
            primaryCheckbox: "char_vtPrimaryAction",
            bonusField: "traitVtBonus"
        },
        char_accuracy: {
            base: 0,
            keys: ["char_tier", "char_acMod", "char_focus"],
            weakenKey: "char_weakenAccuracy",
            primaryCheckbox: "char_acPrimaryAction",
            bonusField: "traitAcBonus"
        },
        char_damage: {
            base: 0,
            keys: ["char_tier", "char_dgMod", "char_power"],
            weakenKey: "char_weakenDamage",
            multiplier: 1.5,
            specificKey: "char_power",
            primaryCheckbox: "char_dgPrimaryAction",
            bonusField: "traitDgBonus"
        },
        char_conditions: {
            base: 0,
            keys: ["char_tier", "char_cnMod", "char_power"],
            weakenKey: "char_weakenConditions",
            multiplier: 1,
            specificKey: "char_tier",
            primaryCheckbox: "char_cnPrimaryAction",
            bonusField: "traitCnBonus"
        },
        char_initiative: {
            base: 0,
            keys: ["char_tier", "char_mobility", "char_focus", "char_awareness", "char_initiativeMod"],
            primaryCheckbox: "char_initiativePrimaryAction"
        }
    };

    // Generic handler function for attribute calculation
    const calculateAttribute = (attrKey, config) => {
        const eventKeys = [
            ...config.keys.map(key => `change:${key}`),
            `change:${config.weakenKey}`,
            `change:${config.primaryCheckbox}`,
            "sheet:opened",
            "change:repeating_traits remove:repeating_traits"
        ].join(" ");

        on(eventKeys, function () {
            const requiredKeys = [
                ...config.keys,
                config.weakenKey,
                config.primaryCheckbox
            ];

            getAttrs(requiredKeys, function (values) {
                let total = config.base;

                // Add static keys
                total += config.keys.reduce((sum, key) => {
                    const multiplier = key === config.specificKey ? config.multiplier || 1 : 1;
                    return sum + (parseInt(values[key]) || 0) * multiplier;
                }, 0);

                // Add bonuses from repeating traits
                getSectionIDs("repeating_traits", ids => {
                    const fields = ids.flatMap(id => [
                        `repeating_traits_${id}_traitActive`,
                        `repeating_traits_${id}_${config.bonusField}`
                    ]);

                    getAttrs(fields, traitValues => {
                        ids.forEach(id => {
                            if (traitValues[`repeating_traits_${id}_traitActive`] === "1") {
                                total += parseInt(traitValues[`repeating_traits_${id}_${config.bonusField}`]) || 0;
                            }
                        });

                        // Subtract weaken key if present
                        if (config.weakenKey) {
                            total -= parseInt(values[config.weakenKey]) || 0;
                        }

                        // Add `char_tier` if primary action checkbox is checked
                        if (values[config.primaryCheckbox] === "on") {
                            total += parseInt(values.char_tier) || 0;
                        }

                        // Round up the final total (will only affect durability since it's the only one with decimals)
                        total = Math.ceil(total);

                        setAttrs({ [attrKey]: total });
                    });
                });
            });
        });
    };

    // Special movement calculation with Swift and minimum tier 6
    on('change:char_tier change:char_mobility change:char_movementMod change:char_swift change:char_weakenMovement change:char_movementPrimaryAction sheet:opened change:repeating_traits remove:repeating_traits', function () {
        const requiredKeys = ["char_tier", "char_mobility", "char_movementMod", "char_swift", "char_weakenMovement", "char_movementPrimaryAction"];

        getAttrs(requiredKeys, function (values) {
            const tier = parseInt(values.char_tier) || 0;
            const mobility = parseInt(values.char_mobility) || 0;
            
            // Base movement: Tier + Mobility, but minimum tier of 6
            let total = Math.max(tier, 6) + mobility;
            
            // Add movement modifier
            total += (parseInt(values.char_movementMod) || 0);
            
            // Add Swift bonus (+½ Tier, rounded up) - uses actual tier, not the minimum 6
            if (values.char_swift === "1") {
                total += Math.ceil(tier / 2);
            }

            // Handle traits (same pattern as generic function)
            getSectionIDs("repeating_traits", ids => {
                if (!ids || ids.length === 0) {
                    // Complete calculation without traits
                    total -= (parseInt(values.char_weakenMovement) || 0);
                    if (values.char_movementPrimaryAction === "on") {
                        total += tier;
                    }
                    setAttrs({ char_movement: total });
                    return;
                }

                const fields = ids.flatMap(id => [
                    `repeating_traits_${id}_traitActive`,
                    `repeating_traits_${id}_traitMBonus`
                ]);

                getAttrs(fields, traitValues => {
                    ids.forEach(id => {
                        if (traitValues[`repeating_traits_${id}_traitActive`] === "1") {
                            total += parseInt(traitValues[`repeating_traits_${id}_traitMBonus`]) || 0;
                        }
                    });

                    total -= (parseInt(values.char_weakenMovement) || 0);
                    if (values.char_movementPrimaryAction === "on") {
                        total += tier;
                    }

                    setAttrs({ char_movement: total });
                });
            });
        });
    });

    // Initialize calculations for each attribute
    Object.entries(attributeCalculations).forEach(([attrKey, config]) => calculateAttribute(attrKey, config));

</script>


</main>